{
    "name": "account_vendor_last30_ctr",
    "keys": ["Id_Zid", "Media_VendorId", "Bid_CompanyId", "EventDate"],
    "values": ["a{account}_v{vendor}_last30_imp", "a{account}_v{vendor}_last30_clk", "a{account}_v{vendor}_last30_ctr"],
    "sql": "\n            (select\n                Id_Zid,\n                {vendor} as Media_VendorId,\n                {account} as Bid_CompanyId,\n                sum(IMP) as a{account}_v{vendor}_last30_imp,\n                sum(CLK) as a{account}_v{vendor}_last30_clk,\n                case\n                    when a{account}_v{vendor}_last30_imp < a{account}_v{vendor}_last30_clk then 1.0\n                    when a{account}_v{vendor}_last30_imp >= a{account}_v{vendor}_last30_clk then floor(a{account}_v{vendor}_last30_clk/a{account}_v{vendor}_last30_imp*1.0,1)\n                    else null\n                end as a{account}_v{vendor}_last30_ctr,\n                (toDate('{target_day:%Y-%m-%d}')) as EventDate\n            from\n                (\n                    select\n                        Id_Zid,\n                        sum(length(Click.Timestamp)) as CLK,\n                        sum(length(Impression.Timestamp)) as IMP\n                    from\n                        zampda.rtb_all\n                    prewhere\n                        EventDate >= toDate('{target_day:%Y-%m-%d}')-30 and  EventDate <= toDate('{target_day:%Y-%m-%d}')-1 and TotalErrorCode=0\n                    where\n                        Media_VendorId = {vendor}\n                        and Bid_CompanyId = {account}\n                        and notEmpty(Impression.Timestamp)\n                    group by Id_Zid\n                )\n            where Id_Zid in (\n                    select Id_Zid\n                    from zampda.rtb_all\n                    prewhere\n                        EventDate >= toDate('{target_day:%Y-%m-%d}')-1 and  EventDate <= toDate('{target_day:%Y-%m-%d}') and TotalErrorCode=0\n                    where\n                        notEmpty(Impression.Timestamp)\n                        and Media_VendorId = {vendor}\n                        and Bid_CompanyId  = {account}\n            )\n            group by Id_Zid)\n\n            ",
    "data_date_col": "target_day",
    "output_name": "a{account}_v{vendor}_t{target_day:%Y%m%d}"
}
